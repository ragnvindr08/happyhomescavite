import React, { useState, useEffect } from 'react';
import NavBar from './NavBar';
import { Link } from 'react-router-dom';
import { ToastContainer } from 'react-toastify';
import 'react-toastify/dist/ReactToastify.css';
import './PageStyles.css';
import './AdminServiceFee.css';
import './AdminDashboard.css';
import axios from 'axios';
import { getToken } from '../utils/auth';
import API_URL from '../utils/config';
import DeleteIcon from '@mui/icons-material/Delete';
import EditIcon from '@mui/icons-material/Edit';
import AddIcon from '@mui/icons-material/Add';
import SaveIcon from '@mui/icons-material/Save';
import CancelIcon from '@mui/icons-material/Cancel';
import SearchIcon from '@mui/icons-material/Search';
import ClearIcon from '@mui/icons-material/Clear';
import ImageIcon from '@mui/icons-material/Image';
import AttachMoneyIcon from '@mui/icons-material/AttachMoney';
import PersonIcon from '@mui/icons-material/Person';
import DescriptionIcon from '@mui/icons-material/Description';

interface ServiceFee {
  id?: number;
  homeowner: number;
  homeowner_id?: number;
  homeowner_name?: string;
  homeowner_email?: string;
  bill_image?: string;
  receipt_image?: string;
  policy_image?: string;
  amount?: string;
  due_date?: string;
  status: 'unpaid' | 'paid' | 'delayed';
  month?: string;
  year?: number;
  notes?: string;
  created_at?: string;
  updated_at?: string;
}

interface Homeowner {
  id: number;
  username: string;
  email: string;
}

const AdminServiceFee: React.FC = () => {
  const [serviceFees, setServiceFees] = useState<ServiceFee[]>([]);
  const [homeowners, setHomeowners] = useState<Homeowner[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [editingId, setEditingId] = useState<number | null>(null);
  const [showAddForm, setShowAddForm] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const [searchType, setSearchType] = useState<'name' | 'id'>('name');
  const [formData, setFormData] = useState<ServiceFee>({
    homeowner: '' as any,
    amount: '',
    due_date: '',
    status: 'unpaid',
    month: '',
    year: new Date().getFullYear(),
    notes: '',
  });
  const [billImageFile, setBillImageFile] = useState<File | null>(null);
  const [imagePreview, setImagePreview] = useState<string | null>(null);
  const [fileInputKey, setFileInputKey] = useState<number>(0);
  const [policyImageFile, setPolicyImageFile] = useState<File | null>(null);
  const [policyImagePreview, setPolicyImagePreview] = useState<string | null>(null);
  const [policyFileInputKey, setPolicyFileInputKey] = useState<number>(0);

  useEffect(() => {
    fetchServiceFees();
    fetchHomeowners();
  }, []);

  useEffect(() => {
    if (searchTerm) {
      fetchServiceFees();
    } else {
      fetchServiceFees();
    }
  }, [searchTerm, searchType]);

  const fetchHomeowners = async () => {
    try {
      const token = getToken();
      const headers: any = {};
      if (token) {
        headers.Authorization = `Bearer ${token}`;
      }
      // Fetch verified homeowners (non-admin users)
      const response = await axios.get(`${API_URL}/admin/users/`, { headers });
      const users = Array.isArray(response.data) ? response.data : (response.data.results || []);
      // Filter to only verified, non-admin users
      const verifiedHomeowners = users
        .filter((user: any) => !user.is_staff && (user.profile?.is_verified || user.is_verified))
        .map((user: any) => ({
          id: user.id,
          username: user.username || user.user?.username || 'Unknown',
          email: user.email || user.user?.email || '',
        }));
      setHomeowners(verifiedHomeowners);
    } catch (err: any) {
      console.error('Error fetching homeowners:', err);
    }
  };

  const fetchServiceFees = async () => {
    try {
      setLoading(true);
      setError(null);
      const token = getToken();
      const headers: any = {};
      if (token) {
        headers.Authorization = `Bearer ${token}`;
      }

      let url = `${API_URL}/service-fees/`;
      if (searchTerm) {
        if (searchType === 'id') {
          url += `?homeowner_id=${searchTerm}`;
        } else {
          url += `?homeowner_name=${searchTerm}`;
        }
      }

      const response = await axios.get(url, { headers, timeout: 10000 });
      const data = Array.isArray(response.data) ? response.data : (response.data.results || []);
      setServiceFees(data);
    } catch (err: any) {
      console.error('Error fetching service fees:', err);
      if (err.code === 'ECONNABORTED') {
        setError('Request timed out. Please check your connection and try again.');
      } else if (err.response) {
        setError(err.response.data?.detail || `Server error (${err.response.status})`);
      } else {
        setError('Failed to load service fees. Please try again later.');
      }
    } finally {
      setLoading(false);
    }
  };

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: name === 'homeowner' || name === 'year' ? parseInt(value) || 0 : value
    }));
  };

  const handleImageChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) {
      const file = e.target.files[0];
      setBillImageFile(file);
      const reader = new FileReader();
      reader.onloadend = () => {
        setImagePreview(reader.result as string);
      };
      reader.readAsDataURL(file);
    } else {
      setBillImageFile(null);
      setImagePreview(null);
    }
  };

  const handlePolicyImageChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) {
      const file = e.target.files[0];
      setPolicyImageFile(file);
      const reader = new FileReader();
      reader.onloadend = () => {
        setPolicyImagePreview(reader.result as string);
      };
      reader.readAsDataURL(file);
    } else {
      setPolicyImageFile(null);
      setPolicyImagePreview(null);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const token = getToken();
      if (!token) {
        setError('You must be logged in to perform this action.');
        return;
      }

      const formDataToSend = new FormData();
      formDataToSend.append('homeowner', formData.homeowner.toString());
      if (formData.amount) formDataToSend.append('amount', formData.amount);
      if (formData.due_date) formDataToSend.append('due_date', formData.due_date);
      formDataToSend.append('status', formData.status);
      if (formData.month) formDataToSend.append('month', formData.month);
      if (formData.year) formDataToSend.append('year', formData.year.toString());
      if (formData.notes) formDataToSend.append('notes', formData.notes);
      if (billImageFile) {
        formDataToSend.append('bill_image', billImageFile);
      }
      if (policyImageFile) {
        formDataToSend.append('policy_image', policyImageFile);
      }

      if (editingId) {
        await axios.patch(`${API_URL}/service-fees/${editingId}/`, formDataToSend, {
          headers: {
            Authorization: `Bearer ${token}`,
            'Content-Type': 'multipart/form-data',
          },
        });
      } else {
        await axios.post(`${API_URL}/service-fees/`, formDataToSend, {
          headers: {
            Authorization: `Bearer ${token}`,
            'Content-Type': 'multipart/form-data',
          },
        });
      }

      setShowAddForm(false);
      setEditingId(null);
      setFormData({
        homeowner: 0,
        amount: '',
        due_date: '',
        status: 'unpaid',
        month: '',
        year: new Date().getFullYear(),
        notes: '',
      });
      setBillImageFile(null);
      setImagePreview(null);
      setFileInputKey(prev => prev + 1);
      setPolicyImageFile(null);
      setPolicyImagePreview(null);
      setPolicyFileInputKey(prev => prev + 1);
      fetchServiceFees();
    } catch (err: any) {
      console.error('Error saving service fee:', err);
      const errorMessage = err.response?.data?.detail || 
                          err.response?.data?.message || 
                          (err.response?.data && typeof err.response.data === 'object' ? JSON.stringify(err.response.data) : null) ||
                          err.message || 
                          'Failed to save service fee. Please try again.';
      setError(errorMessage);
      console.error('Full error response:', err.response?.data);
    }
  };

  const handleEdit = (serviceFee: ServiceFee) => {
    setEditingId(serviceFee.id || null);
    setFormData({
      homeowner: serviceFee.homeowner_id || serviceFee.homeowner,
      amount: serviceFee.amount || '',
      due_date: serviceFee.due_date || '',
      status: serviceFee.status,
      month: serviceFee.month || '',
      year: serviceFee.year || new Date().getFullYear(),
      notes: serviceFee.notes || '',
    });
    setImagePreview(serviceFee.bill_image || null);
    setBillImageFile(null);
    setPolicyImagePreview(serviceFee.policy_image || null);
    setPolicyImageFile(null);
    setShowAddForm(true);
  };

  const handleDelete = async (id: number) => {
    if (!window.confirm('Are you sure you want to delete this service fee?')) {
      return;
    }
    try {
      const token = getToken();
      if (!token) {
        setError('You must be logged in to perform this action.');
        return;
      }
      await axios.delete(`${API_URL}/service-fees/${id}/`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      fetchServiceFees();
    } catch (err: any) {
      console.error('Error deleting service fee:', err);
      setError(err.response?.data?.detail || 'Failed to delete service fee. Please try again.');
    }
  };

  const handleCancel = () => {
    setShowAddForm(false);
    setEditingId(null);
    setFormData({
      homeowner: 0,
      amount: '',
      due_date: '',
      status: 'unpaid',
      month: '',
      year: new Date().getFullYear(),
      notes: '',
    });
    setBillImageFile(null);
    setImagePreview(null);
    setFileInputKey(prev => prev + 1);
    setPolicyImageFile(null);
    setPolicyImagePreview(null);
    setPolicyFileInputKey(prev => prev + 1);
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'paid':
        return '#4caf50';
      case 'delayed':
        return '#ff9800';
      case 'unpaid':
        return '#f44336';
      default:
        return '#757575';
    }
  };

  const months = [
    'January', 'February', 'March', 'April', 'May', 'June',
    'July', 'August', 'September', 'October', 'November', 'December'
  ];

  return (
    <>
      <NavBar />
      <ToastContainer position="top-right" autoClose={3000} />
      <div className="dashboard-layout">
        <aside className="dashboard-sidebar">
          <h2 className="sidebar-title">Admin Panel</h2>
          <ul className="sidebar-menu">
            <li><Link to="/admin-dashboard/map">Manage Pins on Map</Link></li>
            <li><Link to="/admin-dashboard/users">Manage Users</Link></li>
            <li><Link to="/admin-booking">Booking</Link></li>
            <li><Link to="/activity-log">Activity Log</Link></li>
            <li><Link to="/visitors-tracking">Visitors Tracking</Link></li>
            <li><Link to="/booking-reports">Booking Reports</Link></li>
            <li><Link to="/admin-verification">User Verification</Link></li>
            <li><Link to="/admin-faq">Manage FAQs</Link></li>
            <li><Link to="/admin-service-fee">Service Fee</Link></li>
            <hr style={{ borderColor: 'rgba(255, 255, 255, 0.2)' }} />
          </ul>
        </aside>

        <main className="dashboard-main">
        <div className="admin-service-fee-container">
          <div className="admin-service-fee-header">
            <h1>Service Fee Management</h1>
            <button
              className="add-button"
              onClick={() => {
                setShowAddForm(true);
                setEditingId(null);
                setFormData({
                  homeowner: 0,
                  amount: '',
                  due_date: '',
                  status: 'unpaid',
                  month: '',
                  year: new Date().getFullYear(),
                  notes: '',
                });
                setBillImageFile(null);
                setImagePreview(null);
              }}
            >
              <AddIcon /> Add Service Fee
            </button>
          </div>

          {/* Search/Filter Section */}
          <div className="search-section">
            <div className="search-controls">
              <select
                className="search-type-select"
                value={searchType}
                onChange={(e) => setSearchType(e.target.value as 'name' | 'id')}
              >
                <option value="name">Search by Name</option>
                <option value="id">Search by ID</option>
              </select>
              <div className="search-input-wrapper">
                <SearchIcon className="search-icon" />
                <input
                  type="text"
                  className="search-input"
                  placeholder={searchType === 'id' ? 'Enter homeowner ID...' : 'Enter homeowner name...'}
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                />
                {searchTerm && (
                  <button
                    className="clear-search-button"
                    onClick={() => setSearchTerm('')}
                  >
                    <ClearIcon />
                  </button>
                )}
              </div>
            </div>
          </div>

          {error && <div className="error-message">{error}</div>}

          {showAddForm && (
            <div className="form-container">
              <h2>{editingId ? 'Edit Service Fee' : 'Add New Service Fee'}</h2>
              <form onSubmit={handleSubmit}>
                <div className="form-group">
                  <label>
                    <PersonIcon /> Homeowner *
                  </label>
                  <select
                    name="homeowner"
                    value={formData.homeowner}
                    onChange={handleInputChange}
                    required
                  >
                    <option value="">Select Homeowner</option>
                    {homeowners.map((homeowner) => (
                      <option key={homeowner.id} value={homeowner.id}>
                        {homeowner.username} ({homeowner.email})
                      </option>
                    ))}
                  </select>
                </div>

                <div className="form-row">
                  <div className="form-group">
                    <label>
                      <AttachMoneyIcon /> Amount
                    </label>
                    <div style={{ position: 'relative', display: 'flex', alignItems: 'center' }}>
                      <span style={{ marginRight: '8px', color: '#666' }}>₱</span>
                      <input
                        type="number"
                        name="amount"
                        step="0.01"
                        value={formData.amount}
                        onChange={handleInputChange}
                        placeholder="0.00"
                        style={{ flex: 1 }}
                      />
                    </div>
                  </div>

                  <div className="form-group">
                    <label>Due Date</label>
                    <input
                      type="date"
                      name="due_date"
                      value={formData.due_date}
                      onChange={handleInputChange}
                    />
                  </div>
                </div>

                <div className="form-row">
                  <div className="form-group">
                    <label>Month</label>
                    <select
                      name="month"
                      value={formData.month}
                      onChange={handleInputChange}
                    >
                      <option value="">Select Month</option>
                      {months.map((month) => (
                        <option key={month} value={month}>
                          {month}
                        </option>
                      ))}
                    </select>
                  </div>

                  <div className="form-group">
                    <label>Year</label>
                    <input
                      type="number"
                      name="year"
                      value={formData.year}
                      onChange={handleInputChange}
                      min="2020"
                      max="2100"
                    />
                  </div>

                  <div className="form-group">
                    <label>Status *</label>
                    <select
                      name="status"
                      value={formData.status}
                      onChange={handleInputChange}
                      required
                    >
                      <option value="unpaid">Unpaid</option>
                      <option value="paid">Paid</option>
                      <option value="delayed">Delayed</option>
                    </select>
                  </div>
                </div>

                <div className="form-group">
                  <label>
                    <ImageIcon /> Bill Image
                  </label>
                  <label className="upload-button" style={{ display: 'inline-block', marginTop: '10px', cursor: 'pointer', padding: '10px 20px', backgroundColor: '#2e6F40', color: 'white', borderRadius: '8px', border: 'none', fontSize: '0.95rem', fontWeight: '500' }}>
                    <ImageIcon style={{ marginRight: '8px', verticalAlign: 'middle' }} /> Choose Bill Image
                  <input
                      key={fileInputKey}
                    type="file"
                    accept="image/*"
                    onChange={handleImageChange}
                      style={{ display: 'none' }}
                  />
                  </label>
                  {billImageFile && (
                    <p style={{ marginTop: '10px', color: '#666', fontSize: '0.9rem' }}>
                      Selected: {billImageFile.name}
                    </p>
                  )}
                  {imagePreview && (
                    <div className="image-preview" style={{ marginTop: '15px' }}>
                      <img src={imagePreview} alt="Bill preview" style={{ maxWidth: '300px', maxHeight: '300px', borderRadius: '8px' }} />
                      <button
                        type="button"
                        onClick={() => {
                          setImagePreview(null);
                          setBillImageFile(null);
                          setFileInputKey(prev => prev + 1);
                        }}
                        style={{ marginTop: '10px', padding: '8px 15px', cursor: 'pointer', backgroundColor: '#f44336', color: 'white', border: 'none', borderRadius: '6px' }}
                      >
                        Remove Image
                      </button>
                    </div>
                  )}
                </div>

                <div className="form-group">
                  <label>
                    <DescriptionIcon /> Policy Image (Optional)
                  </label>
                  <p style={{ fontSize: '0.85rem', color: '#666', marginTop: '5px', marginBottom: '10px' }}>
                    Upload a policy document/image to send to this homeowner
                  </p>
                  <label className="upload-button" style={{ display: 'inline-block', marginTop: '10px', cursor: 'pointer', padding: '10px 20px', backgroundColor: '#2e6F40', color: 'white', borderRadius: '8px', border: 'none', fontSize: '0.95rem', fontWeight: '500' }}>
                    <DescriptionIcon style={{ marginRight: '8px', verticalAlign: 'middle' }} /> Choose Policy Image
                    <input
                      key={policyFileInputKey}
                      type="file"
                      accept="image/*"
                      onChange={handlePolicyImageChange}
                      style={{ display: 'none' }}
                    />
                  </label>
                  {policyImageFile && (
                    <p style={{ marginTop: '10px', color: '#666', fontSize: '0.9rem' }}>
                      Selected: {policyImageFile.name}
                    </p>
                  )}
                  {policyImagePreview && (
                    <div className="image-preview" style={{ marginTop: '15px' }}>
                      <img src={policyImagePreview} alt="Policy preview" style={{ maxWidth: '300px', maxHeight: '300px', borderRadius: '8px' }} />
                      <button
                        type="button"
                        onClick={() => {
                          setPolicyImagePreview(null);
                          setPolicyImageFile(null);
                          setPolicyFileInputKey(prev => prev + 1);
                        }}
                        style={{ marginTop: '10px', padding: '8px 15px', cursor: 'pointer', backgroundColor: '#f44336', color: 'white', border: 'none', borderRadius: '6px' }}
                      >
                        Remove Policy Image
                      </button>
                    </div>
                  )}
                </div>

                <div className="form-group">
                  <label>Notes</label>
                  <textarea
                    name="notes"
                    value={formData.notes}
                    onChange={handleInputChange}
                    rows={3}
                    placeholder="Additional notes or description..."
                  />
                </div>

                <div className="form-actions">
                  <button type="submit" className="save-button">
                    <SaveIcon /> {editingId ? 'Update' : 'Create'} Service Fee
                  </button>
                  <button type="button" className="cancel-button" onClick={handleCancel}>
                    <CancelIcon /> Cancel
                  </button>
                </div>
              </form>
            </div>
          )}

          {loading ? (
            <div className="loading-message">Loading service fees...</div>
          ) : serviceFees.length === 0 ? (
            <div className="empty-message">No service fees found.</div>
          ) : (
            <div className="service-fees-list">
              {serviceFees.map((serviceFee) => (
                <div key={serviceFee.id} className="service-fee-card">
                  <div className="service-fee-header">
                    <div className="service-fee-info">
                      <h3>{serviceFee.homeowner_name || `User ID: ${serviceFee.homeowner_id || serviceFee.homeowner}`}</h3>
                      <p className="service-fee-email">{serviceFee.homeowner_email}</p>
                      <p className="service-fee-period">
                        {serviceFee.month || 'N/A'} {serviceFee.year || ''}
                      </p>
                    </div>
                    <div
                      className="status-badge"
                      style={{ backgroundColor: getStatusColor(serviceFee.status) }}
                    >
                      {serviceFee.status.toUpperCase()}
                    </div>
                  </div>

                  <div className="service-fee-details">
                    {serviceFee.amount && (
                      <p><strong>Amount:</strong> ₱{parseFloat(serviceFee.amount).toFixed(2)}</p>
                    )}
                    {serviceFee.due_date && (
                      <p><strong>Due Date:</strong> {new Date(serviceFee.due_date).toLocaleDateString()}</p>
                    )}
                    {serviceFee.notes && (
                      <p><strong>Notes:</strong> {serviceFee.notes}</p>
                    )}
                    {serviceFee.bill_image && (
                      <div className="bill-image-container">
                        <strong>Bill Image (Uploaded by Admin):</strong>
                        <a href={serviceFee.bill_image} target="_blank" rel="noopener noreferrer">
                          <img src={serviceFee.bill_image} alt="Bill" className="bill-image-thumbnail" />
                        </a>
                      </div>
                    )}
                    {serviceFee.policy_image && (
                      <div className="bill-image-container">
                        <strong>Policy Document (Uploaded by Admin):</strong>
                        <a href={serviceFee.policy_image} target="_blank" rel="noopener noreferrer">
                          <img src={serviceFee.policy_image} alt="Policy" className="bill-image-thumbnail" />
                        </a>
                      </div>
                    )}
                    {serviceFee.receipt_image && (
                      <div className="bill-image-container">
                        <strong>Receipt Image (Uploaded by Homeowner):</strong>
                        <a href={serviceFee.receipt_image} target="_blank" rel="noopener noreferrer">
                          <img src={serviceFee.receipt_image} alt="Receipt" className="bill-image-thumbnail" />
                        </a>
                      </div>
                    )}
                  </div>

                  <div className="service-fee-actions">
                    <button
                      className="edit-button"
                      onClick={() => handleEdit(serviceFee)}
                    >
                      <EditIcon /> Edit
                    </button>
                    <button
                      className="delete-button"
                      onClick={() => serviceFee.id && handleDelete(serviceFee.id)}
                    >
                      <DeleteIcon /> Delete
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
        </main>
      </div>
    </>
  );
};

export default AdminServiceFee;

